Subject: [PATCH]
Date: July 01, 2024
From: srihariraghava_konduritirumala@comcast.com
Source: upstream
        https://github.com/libuv/libuv/commit/0f2d7e784a256b54b2385043438848047bc2a629 && https://github.com/libuv/libuv/commit/3530bcc30350d4a6ccf35d2f7b33e23292b9de70 && https://github.com/libuv/libuv/commit/e0327e1d508b8207c9150b6e582f0adf26213c39

Signed-off-by: skondu363 <Srihariraghava_konduritirumala@comcast.com>
---
 src/idna.c       |  8 ++++++--
 test/test-idna.c | 25 ++++++++++++++++++++++++-
 test/test-list.h |  2 ++
 3 files changed, 32 insertions(+), 3 deletions(-)

diff --git a/src/idna.c b/src/idna.c
index 3810000..64c96ab 100644
--- a/src/idna.c
+++ b/src/idna.c
@@ -254,6 +254,9 @@ long uv__idna_toascii(const char* s, const char* se, char* d, char* de) {
   char* ds;
   int rc;
 
+  if (s == se)
+    return UV_EINVAL;
+
   ds = d;
 
   for (si = s; si < se; /* empty */) {
@@ -284,8 +287,9 @@ long uv__idna_toascii(const char* s, const char* se, char* d, char* de) {
       return rc;
   }
 
-  if (d < de)
-    *d++ = '\0';
+  if (d >= de)
+    return UV_EINVAL;
 
+  *d++ = '\0';
   return d - ds;  /* Number of bytes written. */
 }
diff --git a/test/test-idna.c b/test/test-idna.c
index b76853c..5f1b446 100644
--- a/test/test-idna.c
+++ b/test/test-idna.c
@@ -96,6 +96,29 @@ TEST_IMPL(utf8_decode1) {
   return 0;
 }
 
+TEST_IMPL(utf8_decode1_overrun) {
+  const char* p;
+  char b[1];
+  char c[1];
+
+  /* Single byte. */
+  p = b;
+  b[0] = 0x7F;
+  ASSERT_EQ(0x7F, uv__utf8_decode1(&p, b + 1));
+  ASSERT_PTR_EQ(p, b + 1);
+  /* Multi-byte. */
+  p = b;
+  b[0] = 0xC0;
+  ASSERT_EQ((unsigned) -1, uv__utf8_decode1(&p, b + 1));
+  ASSERT_PTR_EQ(p, b + 1);
+
+  b[0] = 0x7F;
+  ASSERT_EQ(UV_EINVAL, uv__idna_toascii(b, b + 0, c, c + 1));
+  ASSERT_EQ(UV_EINVAL, uv__idna_toascii(b, b + 1, c, c + 1));
+
+  return 0;
+}
+
 /* Doesn't work on z/OS because that platform uses EBCDIC, not ASCII. */
 #ifndef __MVS__
 
@@ -126,8 +149,8 @@ TEST_IMPL(idna_toascii) {
   /* Illegal inputs. */
   F("\xC0\x80\xC1\x80", UV_EINVAL);  /* Overlong UTF-8 sequence. */
   F("\xC0\x80\xC1\x80.com", UV_EINVAL);  /* Overlong UTF-8 sequence. */
+  F("", UV_EINVAL);
   /* No conversion. */
-  T("", "");
   T(".", ".");
   T(".com", ".com");
   T("example", "example");
diff --git a/test/test-list.h b/test/test-list.h
index d7c7b08..7458840 100644
--- a/test/test-list.h
+++ b/test/test-list.h
@@ -524,6 +524,7 @@ TEST_DECLARE  (fork_threadpool_queue_work_simple)
 
 TEST_DECLARE  (idna_toascii)
 TEST_DECLARE  (utf8_decode1)
+TEST_DECLARE  (utf8_decode1_overrun)
 TEST_DECLARE  (uname)
 
 TEST_DECLARE  (metrics_idle_time)
@@ -1120,6 +1121,7 @@ TASK_LIST_START
 #endif
 
   TEST_ENTRY  (utf8_decode1)
+  TEST_ENTRY  (utf8_decode1_overrun)
   TEST_ENTRY  (uname)
 
 /* Doesn't work on z/OS because that platform uses EBCDIC, not ASCII. */

##########################################
Date: Apr 16, 2024 1:00 PM
From: 
Subject: Enable Tx Power Envelope tags
Source: Comcast
License: BSD
Upstream-Status: Pending
Signed-off-by: Bogdan Bogush <bogdan.bogush@comcast.com>
##########################################
diff --git a/source/hostap-2.11/src/ap/beacon.c b/source/hostap-2.11/src/ap/beacon.c
index e50f0a0..e501c53 100644
--- a/source/hostap-2.11/src/ap/beacon.c
+++ b/source/hostap-2.11/src/ap/beacon.c
@@ -586,8 +586,8 @@ static size_t he_elem_len(struct hostapd_data *hapd)
 		/* An additional Transmit Power Envelope element for
 		 * default client with unit interpretation of regulatory
 		 * client EIRP */
-		if (hapd->iconf->reg_def_cli_eirp != -1 &&
-		    he_reg_is_sp(hapd->iconf->he_6ghz_reg_pwr_type))
+		if (hapd->iconf->reg_def_cli_eirp != -1 /*&&
+		    he_reg_is_sp(hapd->iconf->he_6ghz_reg_pwr_type)*/)
 			len += 4;
 	}
 #endif /* CONFIG_IEEE80211AX */
diff --git a/source/hostap-2.11/src/ap/ieee802_11.c b/source/hostap-2.11/src/ap/ieee802_11.c
index 88906a6..dacaf4b 100644
--- a/source/hostap-2.11/src/ap/ieee802_11.c
+++ b/source/hostap-2.11/src/ap/ieee802_11.c
@@ -7050,8 +7050,32 @@ u8 * hostapd_eid_txpower_envelope(struct hostapd_data *hapd, u8 *eid)
 						   tx_pwr);
 		}
 
-		if (iconf->reg_def_cli_eirp != -1 &&
-		    he_reg_is_sp(iconf->he_6ghz_reg_pwr_type))
+		switch (hostapd_get_oper_chwidth(iconf)) {
+		case CONF_OPER_CHWIDTH_USE_HT:
+			if (iconf->secondary_channel == 0) {
+				/* Max Transmit Power count = 0 (20 MHz) */
+				tx_pwr_count = 0;
+			} else {
+				/* Max Transmit Power count = 1 (20, 40 MHz) */
+				tx_pwr_count = 1;
+			}
+			break;
+		case CONF_OPER_CHWIDTH_80MHZ:
+			/* Max Transmit Power count = 2 (20, 40, and 80 MHz) */
+			tx_pwr_count = 2;
+			break;
+		case CONF_OPER_CHWIDTH_80P80MHZ:
+		case CONF_OPER_CHWIDTH_160MHZ:
+			/* Max Transmit Power count = 3 (20, 40, 80, 160/80+80 MHz) */
+			tx_pwr_count = 3;
+			break;
+
+		default:
+			return eid;
+		}
+
+		if (iconf->reg_def_cli_eirp != -1 /*&&
+		    he_reg_is_sp(iconf->he_6ghz_reg_pwr_type)*/)
 			eid = hostapd_add_tpe_info(
 				eid, tx_pwr_count, REGULATORY_CLIENT_EIRP,
 				REG_DEFAULT_CLIENT,

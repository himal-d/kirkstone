From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Matter SDK BlueZ Fix <fix@matter>
Date: Mon, 1 Jan 2024 00:00:00 +0000
Subject: [PATCH 1/3] BLE: Add delayed connect after scan to fix error 36

Add a 200ms delay before ConnectDeviceImpl to allow BlueZ to stabilize
after device discovery. This mitigates le-connection-abort-by-local (36)
errors that occur when connecting immediately after discovery.

Issue: Error 36 (le-connection-abort-by-local) during BLE commissioning
Root cause: BlueZ timing issue when connecting immediately after scan
Solution: Add post-discovery delay to allow BlueZ state to stabilize

---
 src/platform/Linux/bluez/BluezEndpoint.cpp | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/src/platform/Linux/bluez/BluezEndpoint.cpp b/src/platform/Linux/bluez/BluezEndpoint.cpp
index 0000000..1111111 100644
--- a/src/platform/Linux/bluez/BluezEndpoint.cpp
+++ b/src/platform/Linux/bluez/BluezEndpoint.cpp
@@ -596,6 +596,12 @@ CHIP_ERROR BluezEndpoint::ConnectDevice(BluezDevice1 & aDevice)
 
 CHIP_ERROR BluezEndpoint::ConnectDevice(BluezDevice1 & aDevice)
 {
+    // Add delay after device discovery to allow BlueZ to stabilize
+    // This mitigates error 36 (le-connection-abort-by-local) that occurs
+    // when connecting immediately after device discovery
+    constexpr uint32_t kPostDiscoveryConnectDelayMs = 200;
+    usleep(kPostDiscoveryConnectDelayMs * 1000);
+
     auto params = std::make_pair(this, &aDevice);
     mConnectCancellable.reset(g_cancellable_new());
     return PlatformMgrImpl().GLibMatterContextInvokeSync(
-- 
2.34.1
